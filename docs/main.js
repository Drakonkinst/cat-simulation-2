let t=5;const e={setLevel(e){t=e},severe(e){t>=1&&console.error(e)},warn(e){t>=2&&console.warn(e)},info(e){t>=3&&console.log(e)},fine(e){t>=4&&console.log(e)},finer(e){t>=5&&console.log(e)}},n={version:'alpha 2.000',options:{instantButtons:!1,fasterButtons:!1,fasterTasks:!1,loggerLevel:5}};function o(t,e){return t==e?t:Math.random()*(e-t)+t}function i(t,e){return+t.toFixed(e)}const l={},s={};function a(){}class d{constructor({id:t=null,cooldown:n=0,saveCooldown:o=!1,onClick:i=a,onFinish:s=a,text:d='button',tooltip:r=null,width:u=null}={}){this.id=t,this.cooldown=n,this.onCooldown=this.cooldown>0,this.saveCooldown=o,this.element=function(t,e){let n=$('<div>').addClass('button').text(e).on('click',(()=>t.click()));return $('<div>').addClass('cooldown').appendTo(n),n}(this,d),this.onClick=i,this.onFinish=s,null==this.id&&this.saveCooldown&&e.warn('Button with no ID cannot save cooldown'),null!=r&&r.exists()&&r.appendTo(this.element),null!=this.id&&this.element.addClass('button_'+this.id),null!=u&&this.element.css('width',u),null!=this.id&&l.hasOwnProperty(this.id)&&this.startCooldown(l[this.id])}static getButton(t){return s[t]}static saveSavedCooldowns(){return JSON.stringify(l)}static loadSavedCooldowns(t){l=JSON.parse(t)}setText(){this.element.text(text)}setCooldown(t){this.cooldown=t}appendTo(t){return this.element.appendTo(t),this}startCooldown(t=null){let e=this.cooldown,n=100;if(null==t||t>e?t=e:n=t/e*100,e<=2)return void this.finish();this.clearCooldown();let o=this;if(this.element.find('.cooldown').width(n+'%').animate({width:'0%'},t,'linear',(()=>{o.clearCooldown(),o.finish()})),this.saveCooldown){l[this.id]=.001*t;let e=setInterval((function(){if(l[this.id]-.5<0)return delete l[this.id],void clearInterval(e);l[this.id]=i(l[this.id]-.5,2)}),500)}this.onCooldown=!0,this.setDisabled(!0)}click(){if(!this.element.hasClass('disabled')){let t=this.onClick();(null==t||t)&&this.startCooldown()}}finish(){this.onFinish()}clearCooldown(){this.onCooldown=!1,this.setDisabled(!1)}setDisabled(t){t||this.onCooldown?t&&this.element.addClass('disabled'):this.element.removeClass('disabled')}}function r(t){return $(t.target).hasClass('menu-btn')}function u(){return!0}let c={},h=null,f=null,p=null,v=null;function w(t){return'.!?'.indexOf(t.slice(-1))>-1}function m(t){$('<div>').addClass('notification').css('opacity',0).text(t).prependTo(h).animate({opacity:1},500,'linear',(function(){!function(){let t=f.position().top+f.outerHeight(!0);$('.notification').each((function(){let e=$(this);e.position().top>t&&e.remove()}))}()}))}function x(t='',n=null,o){t.length>0&&!w(t)&&(e.warn('Message '+t+' does not end with punctuation'),t+='.'),null!=n&&v.id!=n?o||(c.hasOwnProperty(n)||(c[n]=[]),c[n].push(t)):m(t)}class g{constructor(t,e,n,o=n){this.id=t,this.eventTimeout=null,this.callback=function(){e(),this.eventTimeout=null},this.minInterval=n,this.maxInterval=o}scheduleNext(t=1){let n=o(this.minInterval,this.maxInterval)*t;null!=this.eventTimeout&&(clearTimeout(this.eventTimeout),this.eventTimeout=null),n>1?e.finer('Next '+this.id+' event scheduled in '+i(n,2)+' minutes'):e.finer('Next '+this.id+' event scheduled in '+i(60*n,0)+' seconds'),this.eventTimeout=setTimeout(this.callback,6e4*n)}}let C=null,b=null,y=null,T=[],k=[],P=null;function S(){return k.length>0?k[0]:null}function L(){return S().eventPanel}function I(){if(k.length<=0){let t=[];for(let e of T)e.isAvailable()&&t.push(e);if(!(t.length>0))return void y.scheduleNext(.5);{let n=function(t,n=1,i='weight'){e.fine(t);let l=0;for(let e of t)e.hasOwnProperty(i)?l+=e[i]:l+=n;e.fine('Max weight: '+l);let s=o(0,l),a=0,d=0;for(;a<s;){e.fine('Curr weight: '+a+' target: '+s);let o=t[d++];o.hasOwnProperty(i)?a+=o[i]:a+=n}return e.fine('index: '+d),e.fine(t[d-1]),t[d-1]}(t);e.fine('Chose event:'),e.fine(n),function(t){P.keyLock=!0,P.navigation=!1,k.push(t),t.eventPanel=$('<div>').addClass('event event-panel').css('opacity',0),$('<div>').addClass('event-title').text(t.title).appendTo(t.eventPanel),$('<div>').addClass('event-description').appendTo(t.eventPanel),$('<div>').addClass('event-buttons').appendTo(t.eventPanel),'function'==typeof t.getContext&&(t.context=t.getContext());let e=H('start',t);null!=e.notification&&x(e.notification);k.length<=1&&N()}(n)}}y.scheduleNext()}function N(){D('start',!0);let t=L();$('.wrapper').append(t),t.animate({opacity:1},200,'linear'),H(C).blink&&function(){let t=document.title;if(null!=b)return;b=setInterval((()=>{document.title='*** EVENT ***',setTimeout((()=>{document.title=t}),1500)}),3e3)}()}function O(){let t=L();t.animate({opacity:0},200,'linear',(()=>{t.remove();let n=S();delete n.eventPanel,delete n.context,k.shift(),k.length>0?(N(),e.finer(k.length+' events remaining')):(null!=b&&(clearInterval(b),b=null),P.keyLock=!1,P.navigation=!0,$('body').trigger('focus'))}))}function D(t,n=!1){e.finer('Loading scene: '+t),C=t;let o=H(t),i=L();'function'==typeof o.onLoad&&o.onLoad(),null==o.notification||n||x(o.notification),null!=o.eventTitle&&$('.event-title',i).text(o.eventTitle),$('.event-description',i).empty(),$('.event-buttons',i).empty(),function(t){let e=L(),n=$('.event-description',e);for(let e=0;e<t.text.length;++e)$('<div>').text(t.text[e]).appendTo(n);if(null!=t.input){document.onselectstart=r,document.onmousedown=r;let e=$('<input>').attr({type:'text',name:'input',spellcheck:!1,placeholder:t.input}).appendTo(n);null!=t.maxinput&&e.attr('maxlength',t.maxinput),$('<div>').addClass('input-result').css('opacity',0).appendTo(n),n.find('input').trigger('focus').trigger('select')}let o=$('<div>').addClass('exit-buttons').appendTo($('.event-buttons',e));null!=t.buttons&&function(t,e){for(let n in t){if(t.hasOwnProperty(n)){let o=t[n],i=new d({id:n,text:o.text,tooltip:o.tooltip||null,onClick:function(){B(this)},cooldown:o.cooldown}).appendTo(e);null!=o.cooldown&&i.startCooldown()}M()}}(t.buttons,o);$('<div>').addClass('clear').appendTo(o)}(o)}function M(){let t=H(C).buttons;for(let e in t)if(t.hasOwnProperty(e)){let n=d.getButton(e),o=t[e];null==o.available||o.available()||n.setDisabled(!0)}}function B(t){let n=H(C),i=n.buttons[t.id];if(null!=i.click){let t=i.click();if(null!=t&&!t){if('string'==typeof t)if(null==n.input)x(t);else{let e=L().find('.input-result');0==e.css('opacity')&&e.text(t).css('opacity',1).animate({opacity:0},1500,'linear')}return}null!=n.input&&'end'==i.nextScene&&(document.onselectstart=u,document.onmousedown=u)}if(M(),null!=i.notification&&x(i.notification),null!=i.nextScene)if('end'==i.nextScene)t.setDisabled(!0),O();else{let t=function(t){let e=0;for(let n in t)t.hasOwnProperty(n)&&(e+=t[n]);let n=o(0,e),i=0;for(let e in t)if(t.hasOwnProperty(e)&&(i+=t[e],i>=n))return e;return null}(i.nextScene);if(null==t)return e.severe('No suitable scene found after "'+C+'"'),void O();D(t)}}function H(t,e=null){let n=(e=e||S()).scenes[t];return'function'==typeof n?n(e.context):n}const F={keyLock:!1,navigation:!0};$((()=>{e.setLevel(n.options.loggerLevel),v=F,h=$('<div>').addClass('notifications').appendTo('.wrapper'),f=$('<div>').addClass('notify-gradient').appendTo(h),p=$('<div>').addClass('quick-notify').appendTo('.wrapper'),function(t){P=t,T.push({title:'Noises',isAvailable:()=>!0,scenes:{start:{text:['knocking sounds can be heard through the door.','someone\'s out there.'],notification:'someone\'s knocking outside',blink:!0,buttons:{investigate:{text:'investigate',nextScene:{bread:1,treats:1}},ignore:{text:'do nothing',nextScene:'end'}}},bread:{text:['a basket full of warm bread sits on the doorstep.','the streets are silent.'],onLoad:()=>{$SM.addItem('bread',5)},buttons:{leave:{text:'close the door',nextScene:'end'}}},treats:{text:['a handful of cat treats sits on the doorstep, wrapped in colorful ribbons.','the streets are silent.'],onLoad:()=>{$SM.addItem('cat treat',3)},buttons:{leave:{text:'go back inside',nextScene:'end'}}}}}),y=new g('random_event',I,3,6),y.scheduleNext()}(F),new d({text:'Hello, world!',cooldown:1e3,onClick:()=>{var t;e.info('Hello, world!'),x('Hello, world!'),(t='Hello, world!').length>0&&!w(t)&&(e.warn('Message '+t+' does not end with punctuation'),t+='.'),p.stop().text(t).css('opacity',1).animate({opacity:0},3e3,'linear'),I()}}).appendTo($('.main'))}));
//# sourceMappingURL=main.js.map
